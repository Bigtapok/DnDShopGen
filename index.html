      <!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D ShopGen</title>
<link rel="stylesheet" href="/index.css">
</head>
<body>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.40.0"
  }
}
</script>
<script type="module" src="./index.tsx"></script>

    <header>
        <div class="app-title">D&D ShopGen <span class="version-badge">v3.6</span></div>

        <div class="controls-group">
            <span id="fileStatus" class="status-badge">No Data</span>
            <button id="adminUsersBtn" class="hidden" style="margin-left:0.5rem; font-size:0.75rem; padding:4px 8px; background:var(--accent); color:white; border:none; border-radius:4px; cursor:pointer;">Users</button>
        </div>
        <div class="spacer"></div>
        <div class="controls-group">
            <button id="authBtn">Login / Register</button>
            <button id="aboutBtn">About</button> 

            <div class="settings-toggles">
                <label class="switch-label">
                    <span>Dark</span>
                    <input type="checkbox" id="themeToggle" class="switch-input" checked>
                </label>
                <label class="switch-label">
                    <span>Debug</span>
                    <input type="checkbox" id="debugToggle" class="switch-input" checked>
                </label>
                <label class="switch-label">
                    <span>INT</span>
                    <input type="checkbox" id="internalsToggle" class="switch-input">
                </label>
            </div>

            <input type="text" id="seedInput" placeholder="SEED" style="width:80px; text-transform:uppercase;">
            <button id="exportJsonBtn">Export JSON</button>
            <button id="exportFullBtn">Full JSON</button>
            <button id="copyMdBtn">Copy MD</button>
            <button id="clearBtn">Clear</button>
        </div>
    </header>

    <div class="workspace">
        <div class="mode-tabs">
            <button class="mode-tab active" id="modeGeneratorBtn">Procedural Generator</button>
            <button class="mode-tab" id="modeSRDBtn">SRD Shop</button>
            <button class="mode-tab" id="togglePanelBtn" style="flex: 0 0 auto; min-width: 50px; text-align: center; border-left: 1px solid var(--border); margin-left: auto;" title="Toggle Generator Panel">‚ñº</button>
        </div>
        <div class="prompt-panel" id="promptPanel">
            <div class="input-mode-toggle">
                <button id="modeBuilderBtn" class="active">Request Builder</button>
                <button id="modeTextBtn">Advanced: Text Mode</button>
            </div>

            <div id="contextControls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; padding: 0.5rem; background: var(--bg-input); border-radius: var(--radius-md); border: 1px solid var(--border);">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <label style="font-size:0.75rem; color:var(--text-muted); font-weight:600; text-transform:uppercase;">Settlement</label>
                    <select id="ctxSettlement" style="width:100%"><option>Loading...</option></select>
                </div>
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <label style="font-size:0.75rem; color:var(--text-muted); font-weight:600; text-transform:uppercase;">Wealth</label>
                    <select id="ctxWealth" style="width:100%"><option>Loading...</option></select>
                </div>
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <label style="font-size:0.75rem; color:var(--text-muted); font-weight:600; text-transform:uppercase;">Biome</label>
                    <select id="ctxBiome" style="width:100%"><option>Loading...</option></select>
                </div>
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <label style="font-size:0.75rem; color:var(--text-muted); font-weight:600; text-transform:uppercase;">Law</label>
                    <select id="ctxLaw" style="width:100%"><option>Loading...</option></select>
                </div>
            </div>

            <!-- SRD Controls (Hidden by default) -->
            <div id="srdGenControls" style="display:none; gap:1rem; margin-bottom:1rem; align-items:center;">
                <div class="btn-group" style="display:flex; gap:0.5rem">
                    <button id="genModeRandom" class="active">Random</button>
                    <button id="genModeUnique">List of All Items</button>
                </div>
                <div id="poolStatus" style="display:none; align-items:center; gap:0.5rem; font-size:0.9rem;">
                    Pool: <span class="pool-count">0</span>
                </div>
            </div>

            <!-- Tag Selection (Hidden by default) -->
            <div id="srdTagSelector" style="display:none; margin-bottom:1rem;">
                <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                    <input type="text" id="tagSearch" placeholder="Filter tags..." style="flex:1">
                    <button id="tagSelectorBtn">Tags (0)</button>
                </div>
                <div id="activeTagChips" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem;"></div>
                <div id="tagOptionsList" style="display:none; max-height:200px; overflow-y:auto; border:1px solid var(--border); background:var(--bg-card); padding:0.5rem;"></div>
            </div>

            <!-- Saved Shops Panel -->
            <div id="savedShopsPanel" class="hidden">
                <div id="savedShopsList" style="display:grid; gap:0.5rem;">
                    <!-- Populated by JS -->
                    <div style="padding:1rem; text-align:center; color:var(--text-muted);">Loading...</div>
                </div>
            </div>

            <!-- Builder Panel -->
            <div id="builderModePanel">
                <div id="builderRows"></div>
                <button id="addRowBtn" style="font-size:0.8rem; margin-top:0.5rem;">+ Add Row</button>
            </div>

            <!-- Text Panel -->
            <div id="textModePanel" class="hidden">
                <textarea id="promptArea" placeholder="Describe the shop or items... (e.g. 'A magical blacksmith selling fire weapons')"></textarea>
            </div>

            <div class="generate-bar">
                <button id="generateBtn" class="primary" disabled>Generate Batch</button>
                <button id="batchCodeBtn">Batch Code</button>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div class="results-area">
            <div id="shopHeader" class="shop-header hidden">
                <!-- Populated by UI -->
            </div>

            <div id="quickControls" class="quick-controls hidden">

                <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="searchFilter" placeholder="Search results..." style="flex:1; max-width:300px;">
                    <select id="sortSelect">
                        <option value="none">Default Sort</option>
                        <option value="price_asc">Price (Low-High)</option>
                        <option value="price_desc">Price (High-Low)</option>
                        <option value="rarity">Rarity (High-Low)</option>
                        <option value="name">Name</option>
                        <option value="type">Type / Tag</option>
                    </select>
                    <select id="tagDropdown">
                        <option value="">All Tags</option>
                    </select>
                    <!-- Stats -->
                    <div id="statsBar" class="hidden" style="margin-left:auto; font-size:0.85rem; display:flex; gap:1rem; align-items:center; background:rgba(0,0,0,0.2); padding:4px 12px; border-radius:4px;">
                        <span>Total: <strong id="statTotal">0</strong></span>
                        <span style="color:var(--border)">|</span>
                        <span id="statBreakdown"></span>
                    </div>
                </div>
                <!-- Rarity Filters -->
                <div id="rarityFilters" style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; border-top:1px solid var(--border); padding-top:0.5rem;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div id="resultsGrid" class="results-grid hidden"></div>

            <div id="emptyState" class="empty-state">
                <div style="font-size:3rem; margin-bottom:1rem;">‚öîÔ∏è</div>
                <p>Load default data to start.</p>
                <p style="font-size:0.9rem">Supports Generator & SRD modes.</p>
            </div>
        </div>

        <div class="pipeline-logs" id="pipelineLogsPanel">
                        <div class="log-header">
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <button id="toggleLogsBtn" class="btn-icon" style="width:24px; height:24px; font-size:0.7rem; background:rgba(255,255,255,0.1); color:var(--text-main);">‚ñº</button>
                    <strong>PIPELINE LOGS</strong>
                </div>
                <a href="#" id="downloadLogsBtn" style="color:var(--primary); text-decoration:none;">Download Logs</a>
            </div>
            <div id="logContent"></div>
        </div>
         <!-- Modal Overlay -->
        <div id="modalOverlay" class="modal-overlay" style="display:none;">
               <!-- Auth Modal -->
            <div id="authModal" class="modal hidden" style="max-width:400px;">
                <div class="modal-header">
                    <h3 style="margin:0">Account</h3>
                    <button id="authClose" style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                <div style="padding:0 1.25rem; margin-top:1rem;">
                    <div class="modal-tabs">
                        <div class="modal-tab active" id="tabLogin">Login</div>
                        <div class="modal-tab" id="tabRegister">Register</div>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="authStatusMsg" style="display:none; font-size:0.9rem; margin-bottom:1rem; padding:0.5rem; background:rgba(0,0,0,0.2); border-radius:4px;"></div>

                    <div id="viewLogin">
                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:0.4rem; font-size:0.9rem; color:var(--text-muted);">Username</label>
                            <input type="text" id="loginUser" style="width:100%" placeholder="Enter username">
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:0.4rem; font-size:0.9rem; color:var(--text-muted);">Password</label>
                            <input type="password" id="loginPass" style="width:100%" placeholder="Enter password">
                        </div>
                        <button id="doLoginBtn" class="primary" style="width:100%;">Log In</button>
                    </div>
                    
                    <div id="viewRegister" class="hidden">
                        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:1rem;">Create an account to save your balance and settings.</p>
                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:0.4rem; font-size:0.9rem; color:var(--text-muted);">Username</label>
                            <input type="text" id="regUser" style="width:100%" placeholder="Choose a username">
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:0.4rem; font-size:0.9rem; color:var(--text-muted);">Email</label>
                            <input type="email" id="regEmail" style="width:100%" placeholder="Enter email">
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:0.4rem; font-size:0.9rem; color:var(--text-muted);">Password</label>
                            <input type="password" id="regPass" style="width:100%" placeholder="Create a password">
                        </div>
                        <button id="doRegisterBtn" class="primary" style="width:100%;">Register</button>
                    </div>
                </div>
            </div>

            <!-- User Profile Modal -->
            <div id="userProfileModal" class="modal hidden" style="max-width:320px;">
                <div class="modal-header">
                    <h3 style="margin:0">User Profile</h3>
                    <button id="profileClose" style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                <div class="modal-body" style="text-align:center; padding: 2rem 1.25rem;">
                    <div style="font-size:3rem; margin-bottom:0.5rem;">üë§</div>
                    <h3 id="profileName" style="margin:0 0 1.5rem 0; color:var(--primary);">User</h3>
                    <button id="doLogoutBtn" class="primary" style="width:100%; background:var(--danger); border-color:var(--danger);">Log Out</button>
                </div>
            </div>

            <!-- Item Details Modal -->
            <div id="itemModal" class="modal hidden">
                <div class="modal-header">
                    <h3 style="margin:0">Item Details</h3>
                    <button id="modalClose" style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                 <div style="padding:0 1.25rem; margin-top:1rem;">
                    <div class="modal-tabs">
                        <div class="modal-tab active" id="tabDetailsBtn">Details</div>
                        <div class="modal-tab" id="internalsTabBtn">Internals</div>
                    </div>
                </div>
                <div id="modalBody" class="modal-body"></div>
            </div>

            <!-- Batch/Config Modal -->
            <div id="batchModal" class="modal hidden" style="max-width:600px;">
                <div class="modal-header">
                    <h3 style="margin:0">Batch & Shop Config</h3>
                    <button id="batchClose" style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                <div style="padding:0 1.25rem; margin-top:1rem;">
                    <div class="modal-tabs">
                        <div class="modal-tab active" id="tabLoadBatch">Load Shop</div>
                        <div class="modal-tab" id="tabSendBatch">Save / Config</div>
                    </div>
                </div>
                <div class="modal-body">

                    <!-- Load View -->
                    <div id="batchLoadView">
                        <p style="font-size:0.9rem; color:var(--text-muted);">Paste a batch code string to restore a shop.</p>
                        <textarea id="batchLoadArea" style="width:100%; height:150px; margin-bottom:1rem; font-family:monospace; font-size:0.8rem;" placeholder="Paste code here..."></textarea>
                        <button id="executeLoadBatchBtn" class="primary" style="width:100%">Load Shop</button>
                    </div>

                    <!-- Save/Config View -->
                    <div id="batchSendView" class="hidden">
                        <!-- Shop Config -->
                        <div class="shop-config-section" style="margin-bottom: 1rem; border:1px solid var(--border); padding:0.75rem; border-radius:8px; background:rgba(0,0,0,0.1);">
                            <strong style="display:block; margin-bottom:0.5rem; font-size:0.85rem; color:var(--text-muted)">Shop Identity</strong>
                            <div class="shop-config-grid">
                                <input type="text" id="cfgShopPrefix" list="listShopPrefix" placeholder="Prefix">
                                <datalist id="listShopPrefix"></datalist>
                                <input type="text" id="cfgShopNoun" list="listShopNoun" placeholder="Noun">
                                <datalist id="listShopNoun"></datalist>
                                <input type="text" id="cfgShopSuffix" list="listShopSuffix" placeholder="Suffix">
                                <datalist id="listShopSuffix"></datalist>
                                <div class="shop-config-full">
                                    <input type="text" id="cfgShopType" list="listShopType" placeholder="Shop Type">
                                    <datalist id="listShopType"></datalist>
                                </div>
                                <input type="text" id="cfgMerchFirst" list="listMerchFirst" placeholder="Merchant Name">
                                <datalist id="listMerchFirst"></datalist>
                                <input type="text" id="cfgMerchLast" list="listMerchLast" placeholder="Surname">
                                <datalist id="listMerchLast"></datalist>
                                <input type="text" id="cfgMerchRace" list="listMerchRace" placeholder="Race">
                                <datalist id="listMerchRace"></datalist>
                                 <div class="shop-config-full">
                                    <input type="text" id="cfgMerchPers" list="listMerchPers" placeholder="Personality">
                                    <datalist id="listMerchPers"></datalist>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:0.4rem; font-size:0.8rem; color:var(--text-muted);">Batch Options (Hide in code)</label>
                            <div style="display:flex; flex-wrap:wrap; gap:1rem;">
                                 <label><input type="checkbox" id="toggleHidePrice"> Price</label>
                                 <label><input type="checkbox" id="toggleHideDesc"> Desc</label>
                                 <label><input type="checkbox" id="toggleHideName"> Name</label>
                                 <label><input type="checkbox" id="toggleHideRarity"> Rarity</label>
                                 <label><input type="checkbox" id="toggleHideType"> Type</label>
                            </div>
                        </div>

                        <button id="executeGenCodeBtn" style="width:100%; margin-bottom:0.5rem;">Generate Code</button>
                        <textarea id="batchSendArea" readonly style="width:100%; height:80px; font-family:monospace; font-size:0.8rem; color:var(--text-muted);" placeholder="Code will appear here..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Admin Users Modal -->
            <div id="adminUsersModal" class="modal hidden" style="max-width:700px;">
                <div class="modal-header">
                    <h3>User Administration</h3>
                    <button id="adminUsersClose" style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="adminUsersList" style="overflow-x:auto;">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

           <!-- About Modal -->
            <div id="aboutModal" class="modal hidden">
                <div class="modal-header">
                    <h3>About D&D ShopGen</h3>
                    <button id="aboutClose" style="background:none; border:none; color:inherit; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
                <div class="modal-body" style="font-size: 0.9rem; line-height: 1.6;">
                    <p><strong>Version:</strong> 3.6</p>
                    <p>A browser-based procedural generation tool for D&D 5e items and shops.</p>
                    <p>For all questions, problems, and suggestions, please contact us by <a href="mailto:Zloibigtapok@gmail.com" style="color:var(--primary)">Zloibigtapok@gmail.com</a></p>

                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 1rem 0;">

                    <h4 style="margin-bottom:0.5rem; color:var(--text-main);">COMPATIBILITY</h4>
                    <p style="margin-top:0; color:var(--text-muted);">This product is 5E compatible.</p>

                    <h4 style="margin-bottom:0.5rem; color:var(--text-main);">LEGAL / ATTRIBUTION</h4>
                    <p style="margin-top:0; color:var(--text-muted);">
                        This work includes material from the System Reference Document 5.2.1 (‚ÄúSRD 5.2.1‚Äù) by Wizards of the
                        Coast LLC, available at <a href="https://www.dndbeyond.com/srd" target="_blank" style="color:var(--primary)">https://www.dndbeyond.com/srd</a>. The SRD 5.2.1 is licensed under the Creative
                        Commons Attribution 4.0 International License, available at <a href="https://creativecommons.org/licenses/by/4.0/legalcode" target="_blank" style="color:var(--primary)">https://creativecommons.org/licenses/by/4.0/legalcode</a>.
                    </p>

                    <h4 style="margin-bottom:0.5rem; color:var(--text-main);">LICENSE NOTICE</h4>
                    <p style="margin-top:0; color:var(--text-muted);">
                        The SRD 5.2.1 content used in this application is provided under the Creative Commons Attribution 4.0
                        International License (CC BY 4.0). You can review the license terms at the link above.
                    </p>

                    <h4 style="margin-bottom:0.5rem; color:var(--text-main);">DISCLAIMER</h4>
                    <p style="margin-top:0; color:var(--text-muted);">
                        This application is provided ‚Äúas is‚Äù, without warranties of any kind. To the maximum extent permitted by law,
                        the developer is not liable for any damages or losses arising from the use of this application.
                    </p>
                </div>
            </div>
        </div>
        <script type="module" src="/index.tsx"></script>
</body>
</html>
